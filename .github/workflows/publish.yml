name: Publish Workflow

on:
  push:
    branches:
      - main

env:
  DOCKERHUB_USERNAME: ravelloh
  GHCR_IMAGE_NAME: ravelloh/neutralpress

jobs:
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      has_release: ${{ steps.check.outputs.has_release }}
      is_stable_release: ${{ steps.check.outputs.is_stable_release }}
      version: ${{ steps.check.outputs.version }}
      semver: ${{ steps.check.outputs.semver }}
      build_sha: ${{ steps.finalize.outputs.build_sha }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. åˆ¤æ–­è¿™æ¬¡ push æ˜¯å¦æ–°å¢äº† changelog/v*.md æ–‡ä»¶
      - name: Detect New Changelog
        id: check
        run: |
          # å…¼å®¹å¤„ç†ï¼šè·å–æœ¬æ¬¡ push å‰çš„ commit SHA
          BEFORE_SHA="${{ github.event.before }}"
          if [ "$BEFORE_SHA" = "0000000000000000000000000000000000000000" ]; then
            BEFORE_SHA="HEAD^"
          fi

          # å¯»æ‰¾åœ¨è¿™æ¬¡ push ä¸­â€œæ–°å¢(A)â€çš„ç¬¦åˆ changelog/v*.md æ ¼å¼çš„æ–‡ä»¶
          NEW_FILE=$(git diff --name-status "$BEFORE_SHA" "${{ github.sha }}" | awk '$1 == "A" {print $2}' | grep -E "^changelog/v[0-9]+\.[0-9]+\.[0-9]+.*\.md$" | head -n 1 || true)

          if [ -n "$NEW_FILE" ]; then
            VERSION=$(basename "$NEW_FILE" .md) # æå–å®Œæ•´ç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ v5.0.0
            SEMVER=${VERSION#v} # å‰¥ç¦» v ç”¨äº Dockerï¼Œä¾‹å¦‚ 5.0.0

            echo "has_release=true" >> "$GITHUB_OUTPUT"
            if echo "$VERSION" | grep -Eq '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
              echo "is_stable_release=true" >> "$GITHUB_OUTPUT"
            else
              echo "is_stable_release=false" >> "$GITHUB_OUTPUT"
            fi
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "semver=$SEMVER" >> "$GITHUB_OUTPUT"
            echo "file_path=$NEW_FILE" >> "$GITHUB_OUTPUT"
            echo "ğŸ‰ Detected new release triggered by: $NEW_FILE"
          else
            echo "has_release=false" >> "$GITHUB_OUTPUT"
            echo "is_stable_release=false" >> "$GITHUB_OUTPUT"
            echo "version=" >> "$GITHUB_OUTPUT"
            echo "semver=" >> "$GITHUB_OUTPUT"
            echo "file_path=" >> "$GITHUB_OUTPUT"
            echo "â„¹ï¸ No new changelog found. Proceeding with edge build only."
          fi

      # 2. ç”Ÿæˆåˆå¹¶ç‰ˆ Release Notesï¼ˆæ‰‹å†™ Changelog + è‡ªåŠ¨ Git Logï¼‰
      - name: Generate Combined Release Notes
        if: steps.check.outputs.has_release == 'true'
        run: |
          VERSION="${{ steps.check.outputs.version }}"
          FILE_PATH="${{ steps.check.outputs.file_path }}"

          # é¦–å…ˆï¼Œå†™å…¥æ‰‹å†™çš„æ›´æ–°æ—¥å¿—ï¼ˆä½œä¸ºæ­£æ–‡å¤´éƒ¨ï¼‰
          cat "$FILE_PATH" > release.md
          echo "" >> release.md
          echo "---" >> release.md

          # åªå¯»æ‰¾â€œä¸Šä¸€ä¸ªæ­£å¼ç‰ˆâ€tagï¼šä¸¥æ ¼åŒ¹é… vX.Y.Zï¼ˆä¸åŒ…å« alpha/beta/rcï¼‰
          PREV_STABLE_TAG=$(git tag -l --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | grep -vx "$VERSION" | head -n1 || true)
          if [ -z "$PREV_STABLE_TAG" ]; then
            PREV_STABLE_TAG="none"
          fi

          if [ "$PREV_STABLE_TAG" != "none" ]; then
            echo "## è¯¦ç»†å˜æ›´ï¼ˆ${PREV_STABLE_TAG} -> ${VERSION}ï¼‰" >> release.md
          else
            echo "## è¯¦ç»†å˜æ›´ï¼ˆåˆå§‹ç‰ˆæœ¬ -> ${VERSION}ï¼‰" >> release.md
          fi
          echo "" >> release.md

          # é™„åŠ è‡ªåŠ¨ç”Ÿæˆçš„ commit æ—¥å¿—
          if [ "$PREV_STABLE_TAG" != "none" ]; then
            git log "${PREV_STABLE_TAG}"..HEAD --pretty=format:'- [%s](https://github.com/${{ github.repository }}/commit/%H) by @%an' >> release.md
          else
            echo "- åˆå§‹åŒ–ç‰ˆæœ¬" >> release.md
          fi

      - name: Upload Release Notes Artifact
        if: steps.check.outputs.has_release == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release.md
          if-no-files-found: error
          retention-days: 1

      # 3. æ­£å¼ç‰ˆå‘å¸ƒæ—¶ï¼ŒåŒæ­¥æ‰€æœ‰ package.json çš„ versionï¼Œå¹¶æäº¤å› main
      - name: Sync package versions and push
        if: steps.check.outputs.is_stable_release == 'true'
        run: |
          TARGET_VERSION="${{ steps.check.outputs.semver }}"

          # æ›´æ–°ä»“åº“å†…æ‰€æœ‰å— git ç®¡ç†çš„ package.json çš„ version å­—æ®µ
          PACKAGE_FILES=$(git ls-files '**/package.json')
          for file in $PACKAGE_FILES; do
            node -e '
              const fs = require("fs");
              const path = process.argv[1];
              const version = process.argv[2];
              const raw = fs.readFileSync(path, "utf8");
              const json = JSON.parse(raw);
              if (json.version !== version) {
                json.version = version;
                fs.writeFileSync(path, JSON.stringify(json, null, 2) + "\n");
              }
            ' "$file" "$TARGET_VERSION"
          done

          git add -- $PACKAGE_FILES

          # æ²¡æœ‰å˜åŒ–åˆ™ç›´æ¥è·³è¿‡
          if git diff --cached --quiet; then
            echo "â„¹ï¸ package.json version already up-to-date."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "chore(release): sync package versions to v${TARGET_VERSION} [skip ci]"
          git push origin HEAD:${{ github.ref_name }}

      - name: Finalize build commit SHA
        id: finalize
        run: |
          echo "build_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

  build:
    name: Build (${{ matrix.platform }})
    runs-on: ${{ matrix.runner }}
    needs: prepare
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            platform: linux/amd64
            arch: amd64
          - runner: ubuntu-24.04-arm
            platform: linux/arm64
            arch: arm64
    steps:
      - name: Checkout repository at build commit
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.build_sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image by digest
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/web/Dockerfile
          platforms: ${{ matrix.platform }}
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/neutralpress
            ghcr.io/${{ env.GHCR_IMAGE_NAME }}
          outputs: type=image,push-by-digest=true,name-canonical=true,push=true
          labels: |
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ needs.prepare.outputs.build_sha }}
          cache-from: type=gha,scope=web-${{ matrix.arch }}
          cache-to: type=gha,mode=max,scope=web-${{ matrix.arch }}

      - name: Export digest
        run: |
          mkdir -p /tmp/digests
          echo "${{ steps.build.outputs.digest }}" > "/tmp/digests/${{ matrix.arch }}.txt"

      - name: Upload digest artifact
        uses: actions/upload-artifact@v4
        with:
          name: digests-${{ matrix.arch }}
          path: /tmp/digests/${{ matrix.arch }}.txt
          if-no-files-found: error
          retention-days: 1

  publish:
    runs-on: ubuntu-latest
    needs:
      - prepare
      - build
    permissions:
      contents: write
      packages: write
    steps:
      - name: Download digest artifacts
        uses: actions/download-artifact@v4
        with:
          path: /tmp/digests
          pattern: digests-*
          merge-multiple: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build tag arguments
        id: tags
        env:
          HAS_RELEASE: ${{ needs.prepare.outputs.has_release }}
          IS_STABLE_RELEASE: ${{ needs.prepare.outputs.is_stable_release }}
          SEMVER: ${{ needs.prepare.outputs.semver }}
        run: |
          set -euo pipefail

          dockerhub_tags="-t ${{ env.DOCKERHUB_USERNAME }}/neutralpress:edge"
          ghcr_tags="-t ghcr.io/${{ env.GHCR_IMAGE_NAME }}:edge"

          if [ "$IS_STABLE_RELEASE" = "true" ]; then
            dockerhub_tags="$dockerhub_tags -t ${{ env.DOCKERHUB_USERNAME }}/neutralpress:latest"
            ghcr_tags="$ghcr_tags -t ghcr.io/${{ env.GHCR_IMAGE_NAME }}:latest"
          fi

          if [ "$HAS_RELEASE" = "true" ] && [ -n "$SEMVER" ]; then
            dockerhub_tags="$dockerhub_tags -t ${{ env.DOCKERHUB_USERNAME }}/neutralpress:${SEMVER}"
            ghcr_tags="$ghcr_tags -t ghcr.io/${{ env.GHCR_IMAGE_NAME }}:${SEMVER}"
          fi

          echo "dockerhub_args=$dockerhub_tags" >> "$GITHUB_OUTPUT"
          echo "ghcr_args=$ghcr_tags" >> "$GITHUB_OUTPUT"

      - name: Create and push Docker Hub manifest list
        run: |
          set -euo pipefail

          sources=""
          for file in /tmp/digests/*.txt; do
            digest="$(cat "$file")"
            sources="$sources ${{ env.DOCKERHUB_USERNAME }}/neutralpress@${digest}"
          done

          docker buildx imagetools create ${{ steps.tags.outputs.dockerhub_args }} $sources

      - name: Create and push GHCR manifest list
        run: |
          set -euo pipefail

          sources=""
          for file in /tmp/digests/*.txt; do
            digest="$(cat "$file")"
            sources="$sources ghcr.io/${{ env.GHCR_IMAGE_NAME }}@${digest}"
          done

          docker buildx imagetools create ${{ steps.tags.outputs.ghcr_args }} $sources

      - name: Download Release Notes Artifact
        if: needs.prepare.outputs.has_release == 'true'
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: .

      # å‘å¸ƒæ”¾åœ¨æœ€åï¼Œç¡®ä¿é•œåƒæ¸…å•å·²ç»æˆåŠŸåˆ›å»º
      - name: Create GitHub Release
        if: needs.prepare.outputs.has_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.version }}
          name: Release ${{ needs.prepare.outputs.version }}
          body_path: release.md
          target_commitish: ${{ needs.prepare.outputs.build_sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
