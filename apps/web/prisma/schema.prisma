generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  uid Int @id @default(autoincrement())

  // 邮件业务
  email           String  @unique
  emailVerified   Boolean @default(false)
  emailVerifyCode String? @db.VarChar(30)
  emailNotice     Boolean @default(false)

  // 用户信息
  username String  @unique
  nickname String? @db.VarChar(50)
  website  String? @db.VarChar(255)
  bio      String? @db.VarChar(255)
  password String?
  avatar   String? @db.VarChar(255)

  // 统计相关
  createdAt DateTime  @default(now())
  lastUseAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  role   Role       @default(USER)
  status UserStatus @default(ACTIVE)

  // 关系
  accounts      Account[]
  posts         Post[]
  comments      Comment[]
  media         Media[]
  pages         Page[]
  notices       Notice[]
  messages      Message[]      @relation("MessageFrom")
  messagesTo    Message[]      @relation("MessageTo")
  auditLogs     AuditLog[]
  refreshTokens RefreshToken[]

  // 索引优化
  @@index([role])
  @@index([status])
  @@index([createdAt])
  @@index([lastUseAt])
}

// 第三方账户模型 (用于SSO登录)
model Account {
  id                String  @id @default(uuid())
  userUid           Int
  type              String // oauth
  provider          String // google, github
  providerAccountId String // 第三方平台的用户ID
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userUid], references: [uid], onDelete: Cascade)

  // 复合唯一约束，确保同一个用户不能重复绑定同一个第三方账户
  @@unique([provider, providerAccountId])
  // 索引优化
  @@index([userUid])
  @@index([provider])
}

// refresh token 模型
model RefreshToken {
  id        String   @id @default(uuid())
  userUid   Int
  expiresAt DateTime
  createdAt DateTime @default(now())

  // 安全相关拓展
  ipAddress  String?   @db.VarChar(45)
  userAgent  String?   @db.VarChar(1000)
  revokedAt  DateTime?
  lastUsedAt DateTime?

  user User @relation(fields: [userUid], references: [uid], onDelete: Cascade)

  // 索引优化
  @@index([userUid])
  @@index([expiresAt])
}

// 密码重置
model PasswordReset {
  id        String   @id @default(uuid())
  userUid   Int
  createdAt DateTime @default(now())

  @@index([createdAt])
}

model Post {
  id            Int        @id @default(autoincrement())
  title         String
  slug          String     @unique
  content       String
  excerpt       String?    @db.VarChar(500)
  featuredImage String?    @db.VarChar(255)
  status        PostStatus @default(DRAFT)
  isPinned      Boolean    @default(false)
  allowComments Boolean    @default(true)
  publishedAt   DateTime? // 发布时间，用于精确控制发布时间
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  deletedAt     DateTime?
  postMode      PostMode   @default(MARKDOWN)

  userUid Int

  // SEO
  metaDescription String? @db.VarChar(160)
  metaKeywords    String? @db.VarChar(255)
  robotsIndex     Boolean @default(true)

  // 关系
  author     User       @relation(fields: [userUid], references: [uid], onDelete: Cascade)
  tags       Tag[]
  categories Category[]
  comments   Comment[]
  media      Media[]

  // 访问统计关系
  viewCount ViewCountCache?
  // @@index([userUid, status]) // 复合索引：按作者和状态查询

  // 索引优化
  @@index([status])
  @@index([userUid])
  @@index([isPinned])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([status, createdAt]) // 复合索引：按状态和时间查询
}

model Tag {
  slug          String   @id
  name          String   @unique
  description   String?  @db.VarChar(255)
  featuredImage String?  @db.VarChar(255)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  posts         Post[]
}

model Category {
  id            Int      @id @default(autoincrement())
  slug          String
  name          String
  description   String?  @db.VarChar(255)
  featuredImage String?  @db.VarChar(255)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 层级关系
  parentId Int?
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children Category[] @relation("CategoryHierarchy")

  posts Post[]

  // 唯一约束：同一父分类下 slug 和 name 唯一
  @@unique([parentId, slug])
  @@unique([parentId, name])
  // 索引优化
  @@index([parentId])
  @@index([slug])
  @@index([createdAt])
}

// 评论模型
model Comment {
  id        String        @id @default(uuid())
  content   String
  ipAddress String?       @db.VarChar(45) // IP地址，用于反垃圾评论
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  deletedAt DateTime?
  status    CommentStatus @default(PENDING)

  // 关系
  postId Int
  post   Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  // 登录用户评论
  userUid       Int?
  user          User?     @relation(fields: [userUid], references: [uid], onDelete: SetNull)
  // 未登录用户评论
  authorName    String?   @db.VarChar(50)
  authorEmail   String?   @db.VarChar(255)
  authorWebsite String?   @db.VarChar(255)
  // 嵌套评论
  parentId      String?
  parent        Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies       Comment[] @relation("CommentReplies")

  // 层级树形结构字段
  depth      Int    @default(0) // 层级深度 (0=顶级评论)
  path       String @default("") @db.VarChar(2000) // 物化路径，如 "rootId/parentId/selfId"
  sortKey    String @default("") @db.VarChar(500) // DFS 排序键，保证树形顺序
  replyCount Int    @default(0) // 直接子评论数量

  // 索引优化
  @@index([postId])
  @@index([userUid])
  @@index([status])
  @@index([parentId])
  @@index([createdAt])
  @@index([postId, status]) // 复合索引：按文章和状态查询
  @@index([userUid, status]) // 复合索引：按用户和状态查询
  @@index([status, createdAt]) // 复合索引：按状态和时间查询
  @@index([postId, status, sortKey]) // 复合索引：按 DFS 顺序查询评论树
  @@index([postId, status, depth]) // 复合索引：按层级过滤
  @@index([path]) // 物化路径索引：用于查找子树
}

// 媒体文件模型
model Media {
  id           Int       @id @default(autoincrement())
  fileName     String
  originalName String
  mimeType     String    @db.VarChar(100)
  size         Int // 大小，单位字节
  shortHash    String    @db.VarChar(12)
  hash         String    @db.VarChar(64)
  mediaType    MediaType @default(IMAGE)
  // 从属
  posts        Post[]

  // 图片相关
  width       Int?
  height      Int?
  altText     String? @db.VarChar(255)
  blur        String? @db.VarChar(2048)
  thumbnails  Json
  exif        Json
  inGallery   Boolean @default(false)
  isOptimized Boolean @default(false)

  storageUrl        String   @db.VarChar(500)
  createdAt         DateTime @default(now())
  storageProviderId String

  // 上传者
  userUid         Int
  user            User            @relation(fields: [userUid], references: [uid], onDelete: Cascade)
  StorageProvider StorageProvider @relation(fields: [storageProviderId], references: [id], onDelete: Restrict)

  @@unique([shortHash])
  // 索引优化
  @@index([inGallery])
  @@index([userUid])
  @@index([createdAt])
  @@index([fileName])
}

model StorageProvider {
  id          String              @id @default(uuid())
  name        String              @unique @db.VarChar(50) // local/aws-s3/aliyun-oss/qcloud-cos
  type        StorageProviderType @default(LOCAL) // 存储提供商类型
  displayName String              @db.VarChar(100) // 显示名称
  baseUrl     String              @db.VarChar(255) // 基础访问URL
  isActive    Boolean             @default(true) // 是否启用
  isDefault   Boolean             @default(false) // 是否为默认存储

  // 配置信息
  config Json // 存储配置

  // 限制设置
  maxFileSize Int @default(52428800) // 最大文件大小(字节) 默认50MB

  // 路径模板
  pathTemplate String @default("/{year}/{month}/{filename}") // 路径生成模板

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  media Media[]

  @@index([isActive])
}

// 静态页面模型
model Page {
  id          String          @id @default(uuid())
  title       String
  slug        String          @unique
  content     String          @db.Text
  contentType PageContentType @default(MARKDOWN)
  config      Json?
  status      PageStatus      @default(ACTIVE)
  deletedAt   DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // 是否为系统预设页面
  isSystemPage Boolean @default(false)

  // SEO
  metaDescription String? @db.VarChar(160)
  metaKeywords    String? @db.VarChar(255)
  robotsIndex     Boolean @default(true)

  // 创建者
  userUid Int?
  author  User? @relation(fields: [userUid], references: [uid], onDelete: SetNull)

  // 导航关系
  menus Menu[]

  // 索引优化
  @@index([status])
  @@index([userUid])
  @@index([createdAt])
}

model Menu {
  id        String       @id @default(uuid())
  name      String       @db.VarChar(100)
  icon      String?      @db.VarChar(100)
  link      String?      @db.VarChar(255)
  slug      String?      @db.VarChar(100)
  status    MenuStatus   @default(ACTIVE)
  order     Int          @default(0)
  category  MenuCategory @default(COMMON)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // 页面关系 - 如果关联页面，则使用页面的 slug 和 title
  pageId String?
  page   Page?   @relation(fields: [pageId], references: [id], onDelete: SetNull)

  @@unique([slug]) // 移到此处，因为 slug 现在是可选的
  // 索引优化
  @@index([name])
  @@index([createdAt])
  @@index([pageId])
}

// 网站配置模型
model Config {
  key         String   @id
  value       Json
  description String?  @db.VarChar(255)
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  // 索引优化
  @@index([updatedAt])
}

model Notice {
  id        String   @id @default(uuid())
  userUid   Int
  isRead    Boolean  @default(false)
  content   String
  link      String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userUid], references: [uid], onDelete: Cascade)

  @@index([userUid, isRead])
}

model Message {
  id          String   @id @default(uuid())
  content     String   @db.VarChar(10000)
  createdAt   DateTime @default(now())
  fromUserUid Int
  toUserUid   Int
  from        User     @relation("MessageFrom", fields: [fromUserUid], references: [uid], onDelete: Cascade)
  to          User     @relation("MessageTo", fields: [toUserUid], references: [uid], onDelete: Cascade)

  // 索引优化
  @@index([fromUserUid])
  @@index([toUserUid])
  @@index([createdAt])
  @@index([fromUserUid, toUserUid]) // 复合索引：会话查询
}

// 访问量缓存表 - 用于高性能访问统计查询
model ViewCountCache {
  path         String   @id @db.VarChar(500) // 路径作为主键
  cachedCount  Int      @default(0) // 缓存的访问总数
  lastArchived DateTime @default(now()) // 上次存档时间
  lastUpdated  DateTime @updatedAt // 上次更新时间

  // 文章关系
  postSlug String? @unique
  post     Post?   @relation(fields: [postSlug], references: [slug], onDelete: Cascade, onUpdate: Cascade)

  // 索引优化
  @@index([lastArchived])
  @@index([cachedCount])
}

// 页面浏览记录模型
model PageView {
  id        String   @id @default(uuid())
  path      String   @db.VarChar(500)
  timestamp DateTime @default(now())

  // 网络信息
  ipAddress String  @db.VarChar(45)
  userAgent String? @db.VarChar(1000)
  referer   String? @db.VarChar(500)

  // 地理位置信息（由 IP 解析得到）
  country String? @db.VarChar(100) // 国家，如 "中国"
  region  String? @db.VarChar(100) // 省份/州
  city    String? @db.VarChar(100) // 城市

  // 设备和浏览器信息
  browser        String? @db.VarChar(50)
  browserVersion String? @db.VarChar(20)
  os             String? @db.VarChar(50)
  osVersion      String? @db.VarChar(20)
  deviceType     String? @db.VarChar(20) // desktop/mobile/tablet

  // 屏幕和显示信息
  screenSize String? @db.VarChar(20) // "1920x1080" 格式
  language   String? @db.VarChar(10) // zh-CN, en-US等
  timezone   String? @db.VarChar(50)

  // 会话和访客跟踪
  visitorId String  @db.VarChar(100) // 访客ID
  duration  Int?    @default(0) // 停留时长（秒）

  // 索引优化
  @@index([path, timestamp])
  @@index([timestamp])
  @@index([visitorId])
  @@index([country, timestamp]) // 按国家统计
  @@index([region, timestamp]) // 按地区统计
  @@index([city, timestamp]) // 按城市统计
}

// 页面浏览存档表 - 压缩存储历史浏览数据
model PageViewArchive {
  id   String   @id @default(uuid())
  date DateTime @db.Date @unique // 存档日期(每天一条记录)

  // 汇总统计数据
  totalViews     Int @default(0)
  uniqueVisitors Int @default(0)
  totalSessions  Int @default(0)
  bounces        Int @default(0) // 跳出次数（单页会话）
  totalDuration  Int @default(0) // 总停留时长（秒）

  // 路径统计(聚合所有路径的访问数据)
  pathStats Json? // { "path1": { views: 100, visitors: 50 }, "path2": { ... } }

  refererStats Json?

  countryStats Json?
  regionStats  Json?
  cityStats    Json?

  deviceStats  Json?
  browserStats Json?
  osStats      Json?

  screenStats   Json?
  languageStats Json?
  timezoneStats Json?

  createdAt DateTime @default(now())

  // 索引优化
  @@index([date])
}

// 审计日志模型 - 记录系统操作和数据变更
model AuditLog {
  id        Int      @id @default(autoincrement())
  timestamp DateTime @default(now())

  // 操作信息
  action     String @db.VarChar(50) // CREATE/UPDATE/DELETE/LOGIN/LOGOUT等
  resource   String @db.VarChar(50) // User/Post/Comment/Config等资源类型
  resourceId String @db.VarChar(255) // 资源ID

  // 操作者信息
  userUid   Int?
  user      User?   @relation(fields: [userUid], references: [uid], onDelete: SetNull)
  ipAddress String  @db.VarChar(45)
  userAgent String? @db.VarChar(1000)

  // 变更详情
  oldData Json? // 变更前的数据
  newData Json? // 变更后的数据

  // 附加信息
  description String? @db.VarChar(500) // 操作描述
  metadata    Json? // 额外的元数据

  // 索引优化
  @@index([userUid])
  @@index([timestamp])
  @@index([action])
  @@index([resource])
  @@index([resourceId])
  @@index([action, resource]) // 复合索引：按操作类型和资源类型查询
  @@index([userUid, timestamp]) // 复合索引：按用户和时间查询
}

model HealthCheck {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  issues    Json?
}

enum Role {
  USER
  ADMIN
  EDITOR
  AUTHOR
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  NEEDS_UPDATE
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum PageStatus {
  ACTIVE
  SUSPENDED
}

enum CommentStatus {
  PENDING
  APPROVED
  REJECTED
  SPAM
}

enum MenuCategory {
  MAIN
  COMMON
  OUTSITE
}

enum MenuStatus {
  ACTIVE
  SUSPENDED
}

enum PostMode {
  MARKDOWN
  MDX
}

enum PageContentType {
  MARKDOWN
  HTML
  MDX
}

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
  FILE
}

enum StorageProviderType {
  LOCAL
  AWS_S3
  GITHUB_PAGES
  VERCEL_BLOB
}
